# èµ„æºç®¡ç†ç³»ç»Ÿ

## æ¦‚è¿°

èµ„æºç®¡ç†ç³»ç»Ÿæ˜¯ Sky Canvas Render Engine çš„æ ¸å¿ƒç»„ä»¶ï¼Œæä¾›äº†å®Œæ•´çš„èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†ã€æ™ºèƒ½ç¼“å­˜å’Œé«˜æ•ˆçš„å¼‚æ­¥åŠ è½½æœºåˆ¶ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸš€ å¼‚æ­¥èµ„æºåŠ è½½å™¨ (AsyncResourceLoader)

- **ç°ä»£å¼‚æ­¥API**: æ”¯æŒ Promise/async-await æ¨¡å¼
- **å¤šç§èµ„æºç±»å‹**: çº¹ç†ã€å­—ä½“ã€éŸ³é¢‘ã€JSONã€äºŒè¿›åˆ¶ã€SVG
- **æ™ºèƒ½é‡è¯•æœºåˆ¶**: è‡ªåŠ¨é‡è¯•å¤±è´¥çš„åŠ è½½ï¼Œæ”¯æŒæŒ‡æ•°é€€é¿
- **è¿›åº¦è·Ÿè¸ª**: å®æ—¶åŠ è½½è¿›åº¦å›è°ƒï¼ŒåŒ…æ‹¬é€Ÿåº¦å’Œå‰©ä½™æ—¶é—´ä¼°ç®—  
- **å¹¶å‘æ§åˆ¶**: å¯é…ç½®çš„æœ€å¤§å¹¶å‘åŠ è½½æ•°é‡
- **ä¼˜å…ˆçº§é˜Ÿåˆ—**: æŒ‰ä¼˜å…ˆçº§æ’åºå¤„ç†åŠ è½½ä»»åŠ¡
- **å–æ¶ˆæ”¯æŒ**: å¯å–æ¶ˆå•ä¸ªæˆ–æ‰€æœ‰åŠ è½½ä»»åŠ¡
- **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡åŠ è½½å’Œé¢„åŠ è½½
- **äº‹ä»¶é©±åŠ¨**: å®Œæ•´çš„äº‹ä»¶ç³»ç»Ÿï¼Œç›‘å¬åŠ è½½çŠ¶æ€å˜åŒ–

### ğŸ§  æ™ºèƒ½ LRU ç¼“å­˜ (LRUCache)

- **å†…å­˜æ„ŸçŸ¥**: è‡ªåŠ¨ç›‘æ§ç³»ç»Ÿå†…å­˜å‹åŠ›å¹¶è°ƒæ•´ç¼“å­˜è¡Œä¸º
- **LRU ç­–ç•¥**: æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•ï¼Œè‡ªåŠ¨é©±é€æ—§æ•°æ®
- **TTL æ”¯æŒ**: çµæ´»çš„ç”Ÿå­˜æ—¶é—´æ§åˆ¶
- **GPU èµ„æºä¸“ç”¨ç¼“å­˜**: ä¸“é—¨é’ˆå¯¹ GPU èµ„æºçš„ç¼“å­˜ç®¡ç†
- **è‡ªåŠ¨åƒåœ¾æ”¶é›†**: å®šæœŸæ¸…ç†è¿‡æœŸå’Œæ— ç”¨èµ„æº
- **å†…å­˜é¢„ç®—**: ä¸¥æ ¼çš„å†…å­˜é™åˆ¶å’Œä½¿ç”¨ç»Ÿè®¡
- **äº‹ä»¶é€šçŸ¥**: ç¼“å­˜å‘½ä¸­ã€é©±é€ã€å†…å­˜è­¦å‘Šç­‰äº‹ä»¶
- **æ€§èƒ½ç»Ÿè®¡**: å‘½ä¸­ç‡ã€å†…å­˜ä½¿ç”¨ç‡ç­‰æŒ‡æ ‡

### ğŸ—ï¸ å¢å¼ºèµ„æºç®¡ç†å™¨ (EnhancedResourceManager)

- **ç»Ÿä¸€æ¥å£**: æ•´åˆåŠ è½½å™¨å’Œç¼“å­˜ï¼Œæä¾›ç»Ÿä¸€çš„èµ„æºç®¡ç†æ¥å£
- **å¼•ç”¨è®¡æ•°**: è‡ªåŠ¨ç®¡ç†èµ„æºå¼•ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- **åŒå±‚ç¼“å­˜**: æ™®é€šç¼“å­˜ + GPU ä¸“ç”¨ç¼“å­˜
- **é¢„åŠ è½½æ”¯æŒ**: é™é»˜é¢„åŠ è½½å¸¸ç”¨èµ„æº
- **èµ„æºæ± åŒ–**: å¤ç”¨ç›¸ä¼¼èµ„æºï¼Œå‡å°‘å†…å­˜å ç”¨
- **æ€§èƒ½ç›‘æ§**: åŠ è½½æ—¶é—´ã€ç¼“å­˜æ•ˆç‡ç­‰æ€§èƒ½æŒ‡æ ‡
- **è‡ªåŠ¨ä¼˜åŒ–**: æ ¹æ®ä½¿ç”¨æ¨¡å¼è‡ªåŠ¨ä¼˜åŒ–ç¼“å­˜ç­–ç•¥

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç”¨æ³•

```typescript
import { EnhancedResourceManager, ResourceType } from '@sky-canvas/render-engine/resources';

const resourceManager = new EnhancedResourceManager({
  cacheMaxMemory: 100 * 1024 * 1024, // 100MB
  maxConcurrentLoads: 6
});

// åŠ è½½å•ä¸ªèµ„æº
const textureRef = await resourceManager.loadResource({
  id: 'hero-texture',
  url: '/assets/hero.png',
  type: ResourceType.TEXTURE
});

// ä½¿ç”¨èµ„æº
const texture = textureRef.data;
console.log(`Loaded texture: ${texture.width}x${texture.height}`);

// é‡Šæ”¾å¼•ç”¨
resourceManager.releaseResource('hero-texture');
```

### æ‰¹é‡åŠ è½½

```typescript
const resources = [
  { id: 'bg1', url: '/assets/bg1.png', type: ResourceType.TEXTURE },
  { id: 'bg2', url: '/assets/bg2.png', type: ResourceType.TEXTURE },
  { id: 'config', url: '/assets/config.json', type: ResourceType.JSON }
];

const refs = await resourceManager.loadBatch(resources, 'ui-assets');
console.log(`Loaded ${refs.length} resources`);
```

### é¢„åŠ è½½

```typescript
const preloadResources = [
  { id: 'level2-bg', url: '/assets/level2.png', type: ResourceType.TEXTURE },
  { id: 'level2-audio', url: '/assets/level2.mp3', type: ResourceType.AUDIO }
];

// é™é»˜é¢„åŠ è½½ï¼Œä¸é˜»å¡å½“å‰æ“ä½œ
resourceManager.preloadResources(preloadResources);
```

### äº‹ä»¶ç›‘å¬

```typescript
resourceManager.on('resourceLoaded', (ref) => {
  console.log(`Resource loaded: ${ref.id}`);
});

resourceManager.on('memoryWarning', (stats) => {
  console.warn(`Memory usage: ${stats.cache.utilization * 100}%`);
});

resourceManager.on('loadingProgress', (id, progress) => {
  console.log(`${id}: ${progress.percentage}%`);
});
```

### ç›´æ¥ä½¿ç”¨å¼‚æ­¥åŠ è½½å™¨

```typescript
import { AsyncResourceLoader, ResourceType } from '@sky-canvas/render-engine/resources';

const loader = new AsyncResourceLoader({
  maxConcurrentLoads: 4,
  defaultTimeout: 30000
});

// åŠ è½½çº¹ç†
const image = await loader.loadResource({
  id: 'sprite',
  url: '/assets/sprite.png',
  type: ResourceType.TEXTURE,
  priority: 90 // é«˜ä¼˜å…ˆçº§
});
```

### ç›´æ¥ä½¿ç”¨ LRU ç¼“å­˜

```typescript
import { LRUCache, GPUResourceCache } from '@sky-canvas/render-engine/resources';

// æ™®é€šç¼“å­˜
const cache = new LRUCache({
  maxMemory: 50 * 1024 * 1024, // 50MB
  maxItems: 1000,
  defaultTTL: 5 * 60 * 1000    // 5åˆ†é’Ÿ
});

cache.set('user-data', userData, 1024); // æŒ‡å®šå¤§å°
const data = cache.get('user-data');

// GPUèµ„æºç¼“å­˜ï¼ˆè‡ªåŠ¨è°ƒç”¨disposeï¼‰
const gpuCache = new GPUResourceCache({
  maxMemory: 128 * 1024 * 1024 // 128MB
});

gpuCache.set('webgl-texture', webglTexture);
```

## é…ç½®é€‰é¡¹

### EnhancedResourceManager é…ç½®

```typescript
interface ResourceManagerConfig {
  // ç¼“å­˜é…ç½®
  cacheMaxMemory?: number;        // æœ€å¤§ç¼“å­˜å†…å­˜ï¼ˆå­—èŠ‚ï¼‰
  cacheMaxItems?: number;         // æœ€å¤§ç¼“å­˜é¡¹æ•°
  cacheDefaultTTL?: number;       // ç¼“å­˜é¡¹é»˜è®¤å­˜æ´»æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  
  // GPUç¼“å­˜é…ç½®  
  gpuCacheMaxMemory?: number;     // GPUç¼“å­˜æœ€å¤§å†…å­˜
  gpuCacheMaxItems?: number;      // GPUç¼“å­˜æœ€å¤§é¡¹æ•°
  
  // åŠ è½½å™¨é…ç½®
  maxConcurrentLoads?: number;    // æœ€å¤§å¹¶å‘åŠ è½½æ•°
  defaultTimeout?: number;        // é»˜è®¤åŠ è½½è¶…æ—¶æ—¶é—´
  defaultRetries?: number;        // é»˜è®¤é‡è¯•æ¬¡æ•°
  
  // é¢„åŠ è½½é…ç½®
  enablePreloading?: boolean;     // å¯ç”¨é¢„åŠ è½½
  preloadBatchSize?: number;      // é¢„åŠ è½½æ‰¹æ¬¡å¤§å°
  
  // åƒåœ¾æ”¶é›†é…ç½®
  enableAutoGC?: boolean;         // å¯ç”¨è‡ªåŠ¨åƒåœ¾æ”¶é›†
  gcInterval?: number;            // åƒåœ¾æ”¶é›†é—´éš”ï¼ˆæ¯«ç§’ï¼‰
  memoryWarningThreshold?: number; // å†…å­˜è­¦å‘Šé˜ˆå€¼ï¼ˆ0-1ï¼‰
}
```

## æ€§èƒ½ä¼˜åŒ–

### å†…å­˜ç®¡ç†
- è‡ªåŠ¨LRUé©±é€ç­–ç•¥
- GPUèµ„æºè‡ªåŠ¨dispose
- å®šæœŸåƒåœ¾æ”¶é›†
- å†…å­˜ä½¿ç”¨ç›‘æ§å’Œè­¦å‘Š

### åŠ è½½ä¼˜åŒ–
- æ™ºèƒ½å¹¶å‘æ§åˆ¶
- ä¼˜å…ˆçº§é˜Ÿåˆ—
- è‡ªåŠ¨é‡è¯•æœºåˆ¶  
- æ‰¹é‡åŠ è½½å‡å°‘å¼€é”€

### ç¼“å­˜ä¼˜åŒ–
- åŒå±‚ç¼“å­˜æ¶æ„
- å†…å­˜æ„ŸçŸ¥ç¼“å­˜è°ƒæ•´
- è®¿é—®é¢‘ç‡ç»Ÿè®¡
- è‡ªåŠ¨ç¼“å­˜ä¼˜åŒ–

## æ¶æ„è®¾è®¡

```
EnhancedResourceManager
â”œâ”€â”€ AsyncResourceLoader     # å¼‚æ­¥åŠ è½½
â”‚   â”œâ”€â”€ ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†
â”‚   â”œâ”€â”€ å¹¶å‘æ§åˆ¶
â”‚   â”œâ”€â”€ è¿›åº¦è·Ÿè¸ª
â”‚   â””â”€â”€ é‡è¯•æœºåˆ¶
â”œâ”€â”€ MemoryAwareLRUCache    # å†…å­˜æ„ŸçŸ¥ç¼“å­˜
â”‚   â”œâ”€â”€ LRU ç­–ç•¥
â”‚   â”œâ”€â”€ TTL ç®¡ç†
â”‚   â”œâ”€â”€ å†…å­˜ç›‘æ§
â”‚   â””â”€â”€ è‡ªåŠ¨ä¼˜åŒ–
â”œâ”€â”€ GPUResourceCache       # GPUä¸“ç”¨ç¼“å­˜
â”‚   â”œâ”€â”€ èµ„æºè‡ªåŠ¨é‡Šæ”¾
â”‚   â”œâ”€â”€ å¼•ç”¨è®¡æ•°
â”‚   â””â”€â”€ å†…å­˜é¢„ç®—
â””â”€â”€ ç»Ÿè®¡å’Œç›‘æ§
    â”œâ”€â”€ æ€§èƒ½æŒ‡æ ‡
    â”œâ”€â”€ äº‹ä»¶ç³»ç»Ÿ
    â””â”€â”€ è°ƒè¯•ä¿¡æ¯
```

## æœ€ä½³å®è·µ

1. **åˆç†è®¾ç½®ç¼“å­˜å¤§å°**: æ ¹æ®ç›®æ ‡è®¾å¤‡å†…å­˜è®¾ç½®åˆé€‚çš„ç¼“å­˜é™åˆ¶
2. **ä½¿ç”¨é¢„åŠ è½½**: åœ¨åˆé€‚æ—¶æœºé¢„åŠ è½½ä¸‹ä¸ªåœºæ™¯çš„èµ„æº
3. **åŠæ—¶é‡Šæ”¾å¼•ç”¨**: ä¸å†ä½¿ç”¨çš„èµ„æºåº”åŠæ—¶è°ƒç”¨ releaseResource
4. **ç›‘å¬å†…å­˜è­¦å‘Š**: å“åº”å†…å­˜è­¦å‘Šäº‹ä»¶ï¼Œä¸»åŠ¨æ¸…ç†éå…³é”®èµ„æº
5. **è®¾ç½®èµ„æºä¼˜å…ˆçº§**: é‡è¦èµ„æºè®¾ç½®é«˜ä¼˜å…ˆçº§ï¼Œç¡®ä¿ä¼˜å…ˆåŠ è½½
6. **ä½¿ç”¨æ‰¹é‡æ“ä½œ**: æ‰¹é‡åŠ è½½ç›¸å…³èµ„æºï¼Œæé«˜æ•ˆç‡
7. **åˆç†è®¾ç½®TTL**: æ ¹æ®èµ„æºä½¿ç”¨æ¨¡å¼è®¾ç½®åˆé€‚çš„ç”Ÿå­˜æ—¶é—´

## å…¼å®¹æ€§

- æ”¯æŒç°ä»£æµè§ˆå™¨ï¼ˆChrome 60+, Firefox 55+, Safari 12+ï¼‰
- æ”¯æŒ Node.js ç¯å¢ƒï¼ˆéœ€è¦é€‚å½“çš„polyfillï¼‰
- WebGL 1.0 å’Œ 2.0 å…¼å®¹
- TypeScript 4.5+ å®Œæ•´ç±»å‹æ”¯æŒ

## æ‰©å±•æ€§

èµ„æºç®¡ç†ç³»ç»Ÿé‡‡ç”¨æ’ä»¶åŒ–è®¾è®¡ï¼Œå¯ä»¥è½»æ¾æ‰©å±•ï¼š

- æ·»åŠ æ–°çš„èµ„æºç±»å‹
- è‡ªå®šä¹‰ç¼“å­˜ç­–ç•¥
- å®ç°ä¸“ç”¨åŠ è½½å™¨
- é›†æˆç¬¬ä¸‰æ–¹å­˜å‚¨ç³»ç»Ÿ