<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>框架无关渲染引擎示例</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .demo-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .demo-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
            padding-bottom: 8px;
        }
        
        .canvas-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .canvas-wrapper {
            flex: 1;
            min-width: 300px;
        }
        
        .canvas-label {
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
        }
        
        canvas {
            border: 2px solid #ddd;
            border-radius: 4px;
            display: block;
            width: 100%;
            max-width: 400px;
            height: 300px;
            cursor: pointer;
        }
        
        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .info-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .info-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .info-content {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #6c757d;
            white-space: pre-line;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>框架无关渲染引擎示例</h1>
            <p>展示如何使用统一的API在不同渲染后端（Canvas2D、WebGL、WebGPU）上进行图形渲染</p>
        </div>
        
        <div class="demo-section">
            <div class="demo-title">
                基础渲染示例
                <span id="canvas2d-status" class="status info">准备中...</span>
            </div>
            <div class="canvas-container">
                <div class="canvas-wrapper">
                    <div class="canvas-label">Canvas2D 渲染器</div>
                    <canvas id="canvas2d" width="400" height="300"></canvas>
                    <div class="controls">
                        <button class="btn btn-primary" onclick="renderCanvas2D()">渲染</button>
                        <button class="btn btn-secondary" onclick="clearCanvas2D()">清空</button>
                        <button class="btn btn-success" onclick="startAnimation2D()">动画</button>
                    </div>
                </div>
            </div>
            <div class="info-panel">
                <div class="info-title">Canvas2D 渲染信息</div>
                <div id="canvas2d-info" class="info-content">等待渲染...</div>
            </div>
        </div>
        
        <div class="demo-section">
            <div class="demo-title">
                WebGL渲染示例
                <span id="webgl-status" class="status info">准备中...</span>
            </div>
            <div class="canvas-container">
                <div class="canvas-wrapper">
                    <div class="canvas-label">WebGL 渲染器</div>
                    <canvas id="webgl" width="400" height="300"></canvas>
                    <div class="controls">
                        <button class="btn btn-primary" onclick="renderWebGL()">渲染</button>
                        <button class="btn btn-secondary" onclick="clearWebGL()">清空</button>
                        <button class="btn btn-success" onclick="startAnimationWebGL()">动画</button>
                    </div>
                </div>
            </div>
            <div class="info-panel">
                <div class="info-title">WebGL 渲染信息</div>
                <div id="webgl-info" class="info-content">等待渲染...</div>
            </div>
        </div>
        
        <div class="demo-section">
            <div class="demo-title">
                WebGPU渲染示例
                <span id="webgpu-status" class="status info">准备中...</span>
            </div>
            <div class="canvas-container">
                <div class="canvas-wrapper">
                    <div class="canvas-label">WebGPU 渲染器</div>
                    <canvas id="webgpu" width="400" height="300"></canvas>
                    <div class="controls">
                        <button class="btn btn-primary" onclick="renderWebGPU()">渲染</button>
                        <button class="btn btn-secondary" onclick="clearWebGPU()">清空</button>
                        <button class="btn btn-success" onclick="startAnimationWebGPU()">动画</button>
                    </div>
                </div>
            </div>
            <div class="info-panel">
                <div class="info-title">WebGPU 渲染信息</div>
                <div id="webgpu-info" class="info-content">等待渲染...</div>
            </div>
        </div>
        
        <div class="demo-section">
            <div class="demo-title">性能对比</div>
            <div class="info-panel">
                <div class="info-title">渲染性能统计</div>
                <div id="performance-info" class="info-content">暂无数据...</div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // 导入渲染引擎模块
        import {
            createRenderEngine,
            GraphicsAdapterType
        } from '/src/engine/graphics/index.ts';
        
        // 全局变量
        let canvas2dEngine = null;
        let webglEngine = null;
        let webgpuEngine = null;
        let animationId2D = null;
        let animationIdWebGL = null;
        let animationIdWebGPU = null;
        
        // 渲染对象类
        class Rectangle {
            constructor(id, x, y, width, height, color = '#ff0000') {
                this.id = id;
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = color;
                this.visible = true;
                this.zIndex = 0;
            }
            
            get bounds() {
                return {
                    x: this.x,
                    y: this.y,
                    width: this.width,
                    height: this.height
                };
            }
            
            render(context) {
                context.save();
                context.setStyle({ fillColor: this.color });
                context.fillRect(this.x, this.y, this.width, this.height);
                context.restore();
            }
            
            hitTest(point) {
                return point.x >= this.x && 
                       point.x <= this.x + this.width &&
                       point.y >= this.y && 
                       point.y <= this.y + this.height;
            }
            
            getBounds() {
                return this.bounds;
            }
        }
        
        class Circle {
            constructor(id, x, y, radius, color = '#00ff00') {
                this.id = id;
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.color = color;
                this.visible = true;
                this.zIndex = 0;
            }
            
            get bounds() {
                return {
                    x: this.x - this.radius,
                    y: this.y - this.radius,
                    width: this.radius * 2,
                    height: this.radius * 2
                };
            }
            
            render(context) {
                context.save();
                context.setStyle({ fillColor: this.color });
                context.beginPath();
                context.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                context.fill();
                context.restore();
            }
            
            hitTest(point) {
                const dx = point.x - this.x;
                const dy = point.y - this.y;
                return Math.sqrt(dx * dx + dy * dy) <= this.radius;
            }
            
            getBounds() {
                return this.bounds;
            }
        }
        
        // 初始化Canvas2D渲染引擎
        async function initCanvas2D() {
            try {
                const canvas = document.getElementById('canvas2d');
                canvas2dEngine = await createRenderEngine({
                    canvas,
                    adapterType: GraphicsAdapterType.CANVAS_2D,
                    autoRender: false,
                    targetFPS: 60
                });
                
                // 创建渲染层
                const layer = canvas2dEngine.createLayer('main', 0);
                
                // 创建渲染对象
                const rect1 = new Rectangle('rect1', 50, 50, 100, 80, '#ff6b6b');
                const rect2 = new Rectangle('rect2', 200, 100, 120, 60, '#4ecdc4');
                const circle1 = new Circle('circle1', 150, 200, 40, '#45b7d1');
                const circle2 = new Circle('circle2', 300, 180, 35, '#f9ca24');
                
                layer.addRenderable(rect1);
                layer.addRenderable(rect2);
                layer.addRenderable(circle1);
                layer.addRenderable(circle2);
                
                // 设置视口
                canvas2dEngine.setViewport({
                    x: 0,
                    y: 0,
                    width: canvas.width,
                    height: canvas.height,
                    zoom: 1
                });
                
                // 添加点击事件
                canvas.addEventListener('click', (event) => {
                    const rect = canvas.getBoundingClientRect();
                    const point = {
                        x: event.clientX - rect.left,
                        y: event.clientY - rect.top
                    };
                    
                    const hitObject = canvas2dEngine.hitTest(point);
                    if (hitObject) {
                        updateInfo('canvas2d-info', `点击了对象: ${hitObject.id}`);
                    } else {
                        updateInfo('canvas2d-info', '点击了空白区域');
                    }
                });
                
                updateStatus('canvas2d-status', '就绪', 'success');
                updateInfo('canvas2d-info', 'Canvas2D渲染引擎初始化成功');
                
            } catch (error) {
                updateStatus('canvas2d-status', '错误', 'error');
                updateInfo('canvas2d-info', `初始化失败: ${error.message}`);
            }
        }
        
        // 初始化WebGL渲染引擎
        async function initWebGL() {
            try {
                const canvas = document.getElementById('webgl');
                webglEngine = await createRenderEngine({
                    canvas,
                    adapterType: GraphicsAdapterType.WEBGL,
                    autoRender: false,
                    targetFPS: 60
                });
                
                // 创建渲染层
                const layer = webglEngine.createLayer('main', 0);
                
                // 创建渲染对象
                const rect = new Rectangle('webgl-rect', 100, 100, 200, 150, '#9b59b6');
                const circle = new Circle('webgl-circle', 250, 200, 60, '#e74c3c');
                
                layer.addRenderable(rect);
                layer.addRenderable(circle);
                
                // 设置视口
                webglEngine.setViewport({
                    x: 0,
                    y: 0,
                    width: canvas.width,
                    height: canvas.height,
                    zoom: 1
                });
                
                updateStatus('webgl-status', '就绪', 'success');
                updateInfo('webgl-info', 'WebGL渲染引擎初始化成功');
                
            } catch (error) {
                updateStatus('webgl-status', '不支持', 'error');
                updateInfo('webgl-info', `WebGL不支持，回退到Canvas2D: ${error.message}`);
                
                // 回退到Canvas2D
                try {
                    const canvas = document.getElementById('webgl');
                    webglEngine = await createRenderEngine({
                        canvas,
                        adapterType: GraphicsAdapterType.CANVAS_2D,
                        autoRender: false,
                        targetFPS: 60
                    });
                    
                    const layer = webglEngine.createLayer('main', 0);
                    const rect = new Rectangle('fallback-rect', 100, 100, 200, 150, '#9b59b6');
                    const circle = new Circle('fallback-circle', 250, 200, 60, '#e74c3c');
                    
                    layer.addRenderable(rect);
                    layer.addRenderable(circle);
                    
                    webglEngine.setViewport({
                        x: 0,
                        y: 0,
                        width: canvas.width,
                        height: canvas.height,
                        zoom: 1
                    });
                    
                    updateStatus('webgl-status', '回退Canvas2D', 'info');
                    updateInfo('webgl-info', '已回退到Canvas2D渲染');
                } catch (fallbackError) {
                    updateStatus('webgl-status', '失败', 'error');
                    updateInfo('webgl-info', `回退也失败: ${fallbackError.message}`);
                }
            }
        }
        
        // 初始化WebGPU渲染引擎
        async function initWebGPU() {
            try {
                // 检查WebGPU支持
                if (!navigator.gpu) {
                    throw new Error('WebGPU不被支持');
                }
                
                const canvas = document.getElementById('webgpu');
                webgpuEngine = await createRenderEngine({
                    canvas,
                    adapterType: GraphicsAdapterType.WEBGPU,
                    autoRender: false,
                    targetFPS: 60
                });
                
                // 创建渲染层
                const layer = webgpuEngine.createLayer('main', 0);
                
                // 创建渲染对象
                const rect = new Rectangle('webgpu-rect', 80, 80, 180, 120, '#8e44ad');
                const circle = new Circle('webgpu-circle', 280, 180, 50, '#e67e22');
                
                layer.addRenderable(rect);
                layer.addRenderable(circle);
                
                // 设置视口
                webgpuEngine.setViewport({
                    x: 0,
                    y: 0,
                    width: canvas.width,
                    height: canvas.height,
                    zoom: 1
                });
                
                updateStatus('webgpu-status', '就绪', 'success');
                updateInfo('webgpu-info', 'WebGPU渲染引擎初始化成功');
                
            } catch (error) {
                updateStatus('webgpu-status', '不支持', 'error');
                updateInfo('webgpu-info', `WebGPU不支持，回退到Canvas2D: ${error.message}`);
                
                // 回退到Canvas2D
                try {
                    const canvas = document.getElementById('webgpu');
                    webgpuEngine = await createRenderEngine({
                        canvas,
                        adapterType: GraphicsAdapterType.CANVAS_2D,
                        autoRender: false,
                        targetFPS: 60
                    });
                    
                    const layer = webgpuEngine.createLayer('main', 0);
                    const rect = new Rectangle('fallback-webgpu-rect', 80, 80, 180, 120, '#8e44ad');
                    const circle = new Circle('fallback-webgpu-circle', 280, 180, 50, '#e67e22');
                    
                    layer.addRenderable(rect);
                    layer.addRenderable(circle);
                    
                    webgpuEngine.setViewport({
                        x: 0,
                        y: 0,
                        width: canvas.width,
                        height: canvas.height,
                        zoom: 1
                    });
                    
                    updateStatus('webgpu-status', '回退Canvas2D', 'info');
                    updateInfo('webgpu-info', '已回退到Canvas2D渲染');
                } catch (fallbackError) {
                    updateStatus('webgpu-status', '失败', 'error');
                    updateInfo('webgpu-info', `回退也失败: ${fallbackError.message}`);
                }
            }
        }
        
        // 工具函数
        function updateStatus(elementId, text, type) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = `status ${type}`;
        }
        
        function updateInfo(elementId, text) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent = `[${timestamp}] ${text}`;
        }
        
        function updatePerformanceInfo() {
            const canvas2dStats = canvas2dEngine ? canvas2dEngine.getStats() : null;
            const webglStats = webglEngine ? webglEngine.getStats() : null;
            const webgpuStats = webgpuEngine ? webgpuEngine.getStats() : null;
            
            let info = '';
            if (canvas2dStats) {
                info += `Canvas2D - FPS: ${canvas2dStats.fps.toFixed(1)}, 渲染时间: ${canvas2dStats.renderTime.toFixed(2)}ms, 对象数: ${canvas2dStats.objectsRendered}\n`;
            }
            if (webglStats) {
                info += `WebGL - FPS: ${webglStats.fps.toFixed(1)}, 渲染时间: ${webglStats.renderTime.toFixed(2)}ms, 对象数: ${webglStats.objectsRendered}\n`;
            }
            if (webgpuStats) {
                info += `WebGPU - FPS: ${webgpuStats.fps.toFixed(1)}, 渲染时间: ${webgpuStats.renderTime.toFixed(2)}ms, 对象数: ${webgpuStats.objectsRendered}\n`;
            }
            
            if (info) {
                document.getElementById('performance-info').textContent = info;
            }
        }
        
        // 全局函数（供HTML调用）
        window.renderCanvas2D = function() {
            if (canvas2dEngine) {
                const startTime = performance.now();
                canvas2dEngine.render();
                const renderTime = performance.now() - startTime;
                updateInfo('canvas2d-info', `渲染完成，耗时: ${renderTime.toFixed(2)}ms`);
                updatePerformanceInfo();
            }
        };
        
        window.clearCanvas2D = function() {
            if (canvas2dEngine) {
                const context = canvas2dEngine.getContext();
                if (context) {
                    context.clearRect(0, 0, 400, 300);
                    updateInfo('canvas2d-info', '画布已清空');
                }
            }
        };
        
        window.startAnimation2D = function() {
            if (canvas2dEngine && !animationId2D) {
                canvas2dEngine.start();
                animationId2D = true;
                updateInfo('canvas2d-info', '动画已启动');
            }
        };
        
        window.renderWebGL = function() {
            if (webglEngine) {
                const startTime = performance.now();
                webglEngine.render();
                const renderTime = performance.now() - startTime;
                updateInfo('webgl-info', `渲染完成，耗时: ${renderTime.toFixed(2)}ms`);
                updatePerformanceInfo();
            }
        };
        
        window.clearWebGL = function() {
            if (webglEngine) {
                const context = webglEngine.getContext();
                if (context) {
                    context.clearRect(0, 0, 400, 300);
                    updateInfo('webgl-info', '画布已清空');
                }
            }
        };
        
        window.startAnimationWebGL = function() {
            if (webglEngine && !animationIdWebGL) {
                webglEngine.start();
                animationIdWebGL = true;
                updateInfo('webgl-info', '动画已启动');
            }
        };
        
        window.renderWebGPU = function() {
            if (webgpuEngine) {
                const startTime = performance.now();
                webgpuEngine.render();
                const renderTime = performance.now() - startTime;
                updateInfo('webgpu-info', `渲染完成，耗时: ${renderTime.toFixed(2)}ms`);
                updatePerformanceInfo();
            }
        };
        
        window.clearWebGPU = function() {
            if (webgpuEngine) {
                const context = webgpuEngine.getContext();
                if (context) {
                    context.clear();
                    updateInfo('webgpu-info', '画布已清空');
                }
            }
        };
        
        window.startAnimationWebGPU = function() {
            if (webgpuEngine && !animationIdWebGPU) {
                webgpuEngine.start();
                animationIdWebGPU = true;
                updateInfo('webgpu-info', '动画已启动');
            }
        };
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async () => {
            await initCanvas2D();
            await initWebGL();
            await initWebGPU();
            
            // 定期更新性能信息
            setInterval(updatePerformanceInfo, 1000);
        });
    </script>
</body>
</html>